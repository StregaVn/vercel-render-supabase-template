name: CI/CD Pipeline

# ============================================
# GITHUB ACTIONS WORKFLOW
# ============================================
# This workflow runs on push and pull requests
# It builds and tests both backend and frontend
#
# Features:
# - Backend: Build with Maven, run tests
# - Frontend: Install dependencies, type-check, lint, build
# - Caching for faster builds
# - Parallel jobs for speed
# ============================================

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # BACKEND BUILD & TEST
  # ============================================
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('backend/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: Build with Maven
        working-directory: ./backend
        run: ./mvnw clean package -DskipTests
      
      - name: Run tests
        working-directory: ./backend
        run: ./mvnw test
        env:
          DB_URL: jdbc:h2:mem:testdb
          DB_USERNAME: sa
          DB_PASSWORD: ""
          JWT_SECRET: test-secret-key-for-ci-cd-testing-only
          SPRING_PROFILES_ACTIVE: test
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/target/surefire-reports/
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar

  # ============================================
  # FRONTEND BUILD & TEST
  # ============================================
  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Type check
        working-directory: ./frontend
        run: npm run type-check
      
      - name: Lint
        working-directory: ./frontend
        run: npm run lint
      
      - name: Build
        working-directory: ./frontend
        run: npm run build
        env:
          VITE_API_URL: https://api.example.com  # Placeholder for CI
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

  # ============================================
  # SECURITY SCAN (Optional)
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Backend security scan
      - name: Run Trivy vulnerability scanner (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
      
      # Frontend security scan
      - name: Run npm audit (Frontend)
        working-directory: ./frontend
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # ============================================
  # DEPLOYMENT NOTIFICATION
  # ============================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Deployment successful
        run: |
          echo "✅ All checks passed!"
          echo "Backend and Frontend built successfully"
          echo "Ready for deployment to Render and Vercel"

# ============================================
# NOTES
# ============================================
# Automatic Deployments:
# - Render: Auto-deploys from main branch (configured in Render dashboard)
# - Vercel: Auto-deploys from all branches (configured in Vercel dashboard)
#
# Manual Deployments:
# - Render: Dashboard → Manual Deploy
# - Vercel: Dashboard → Deployments → Redeploy
#
# Environment Variables:
# - Set in Render dashboard (backend)
# - Set in Vercel dashboard (frontend)
# - Never commit secrets to Git
#
# Customization:
# - Add more test steps as needed
# - Add code coverage reporting
# - Add integration tests
# - Add E2E tests with Playwright/Cypress
# ============================================

